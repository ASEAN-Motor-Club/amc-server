name: Deploy

on:
  repository_dispatch:
    types: [submodule-update]
  workflow_dispatch:
    inputs:
      submodule:
        description: 'Submodule name (e.g., amc-backend)'
        required: false

jobs:
  deploy:
    runs-on: [self-hosted, deploy]
    steps:
      - uses: actions/checkout@v4
        with:
          # Let Nix handle submodule fetching via access-tokens
          submodules: false
          persist-credentials: false

      - name: Configure Git Auth
        run: |
          mkdir -p $HOME/.ssh
          chmod 700 $HOME/.ssh
          
          # SSH key for server deployment (nixos-rebuild)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > $HOME/.ssh/id_ed25519
          chmod 600 $HOME/.ssh/id_ed25519
          
          # SSH config for server access during nixos-rebuild
          cat > $HOME/.ssh/config << EOF
          Host 127.0.0.1
            IdentityFile $HOME/.ssh/id_ed25519
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 $HOME/.ssh/config
          
          # Configure git to use PAT for submodules Fetching
          # Using relative paths in .gitmodules, combined with the PAT rewrite, 
          # ensures we don't need SSH keys for any repository access.
          TOKEN="${{ secrets.AMC_SERVER_DISPATCH_TOKEN }}"
          git config --global url."https://x-access-token:$TOKEN@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:$TOKEN@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:$TOKEN@github.com/".insteadOf "https://github.com/"
          
          echo "GIT_SSH_COMMAND=ssh -F $HOME/.ssh/config" >> $GITHUB_ENV
          echo "NIX_SSHOPTS=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i $HOME/.ssh/id_ed25519" >> $GITHUB_ENV
      - name: Prepare Submodules
        run: |
          # Sync handles cached URLs on self-hosted runners; git config handles auth
          git submodule sync --recursive
          git submodule update --init --recursive --force

      - name: Update Submodule Reference
        run: |
          SUBMODULE="${{ github.event.client_payload.submodule }}"
          SHA="${{ github.event.client_payload.sha }}"
          
          # Only update if triggered by repository_dispatch with payload
          if [ -n "$SUBMODULE" ] && [ -n "$SHA" ]; then
            # Extract just the repo name (e.g., "amc-backend" from "ASEAN-Motor-Club/amc-backend")
            SUBMODULE_NAME=$(echo "$SUBMODULE" | cut -d'/' -f2)
            
            echo "Updating $SUBMODULE_NAME to $SHA"
            cd "$SUBMODULE_NAME"
            git fetch origin
            git checkout "$SHA"
            cd ..
            
            # Commit and push the submodule update
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$SUBMODULE_NAME"
            git commit -m "chore: update $SUBMODULE_NAME to $SHA" || echo "No changes to commit"
            git push
          else
            echo "No submodule payload; skipping reference update."
          fi

      - name: Deploy
        run: |
          nixos-rebuild switch \
            --target-host root@127.0.0.1 \
            --flake .#asean-mt-server \
            --option access-tokens "github.com=${{ secrets.AMC_SERVER_DISPATCH_TOKEN }}" \
            --fast

      - name: Restart affected services
        run: |
          SUB="${{ github.event.client_payload.submodule || inputs.submodule }}"
          echo "Processing restart for submodule: $SUB"
          
          case "$SUB" in
            *amc-backend*)
              echo "Restarting amc-backend-worker.service"
              ssh root@127.0.0.1 systemctl restart amc-backend-worker.service
              ;;
            *motortown-server*)
              echo "Restarting motortown test/event containers"
              ssh root@127.0.0.1 nixos-container restart test
              ssh root@127.0.0.1 nixos-container restart event
              ;;
            *necesse-server*)
              echo "Restarting necesse-server.service"
              ssh root@127.0.0.1 systemctl restart necesse-server.service
              ;;
            *eco-server*)
              echo "Restarting eco-server.service"
              ssh root@127.0.0.1 systemctl restart eco-server.service
              ;;
            *)
              echo "No specific service restart defined for $SUB"
              ;;
          esac
