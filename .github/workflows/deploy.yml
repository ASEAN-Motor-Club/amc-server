name: Deploy

on:
  repository_dispatch:
    types: [submodule-update]
  workflow_dispatch:
    inputs:
      submodule:
        description: 'Submodule name (e.g., amc-backend)'
        required: false

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          # Don't checkout submodules automatically, we'll do it manually after config
          submodules: false
          fetch-depth: 0
          token: ${{ secrets.AMC_SERVER_DISPATCH_TOKEN }}

      - name: Configure Git to use HTTPS for submodules
        run: |
          # Configure global auth header for all github.com requests
          AUTH=$(echo -n "x-access-token:${{ secrets.AMC_SERVER_DISPATCH_TOKEN }}" | base64 -w 0)
          git config --global http.https://github.com/.extraheader "AUTHORIZATION: basic $AUTH"

      - name: Initialize and update submodules
        run: |
          git submodule init
          
          # If triggered by a submodule update, update that specific one to the SHA
          if [ "${{ github.event.client_payload.sha }}" != "" ]; then
            SUB=$(echo "${{ github.event.client_payload.submodule }}" | sed 's|ASEAN-Motor-Club/||')
            echo "Specifically fetching submodule $SUB at SHA ${{ github.event.client_payload.sha }}"
            git submodule update --init -- $SUB
            cd $SUB && git fetch origin && git checkout ${{ github.event.client_payload.sha }} && cd ..
          fi
          
          # Update all other submodules to what's defined in the repo
          git submodule update --init --recursive

      - name: Deploy
        run: |
          sudo nixos-rebuild switch \
            --flake .#asean-mt-server \
            --option access-tokens "github.com=${{ secrets.AMC_SERVER_DISPATCH_TOKEN }}" \
            --fast

      - name: Restart affected services
        run: |
          SUB="${{ github.event.client_payload.submodule || inputs.submodule }}"
          echo "Processing restart for submodule: $SUB"
          
          case "$SUB" in
            *amc-backend*)
              echo "Restarting amc-backend-worker.service"
              systemctl restart amc-backend-worker.service
              ;;
            *motortown-server*)
              echo "Restarting motortown test/event containers"
              nixos-container restart test
              nixos-container restart event
              ;;
            *necesse-server*)
              echo "Restarting necesse-server.service"
              systemctl restart necesse-server.service
              ;;
            *eco-server*)
              echo "Restarting eco-server.service"
              systemctl restart eco-server.service
              ;;
            *)
              echo "No specific service restart defined for $SUB"
              ;;
          esac
